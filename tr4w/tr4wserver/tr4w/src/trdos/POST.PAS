unit post;
//PROGRAM PostContestLogProcessing;

{ This program is used to do all the post contest processing of the
  LOG.DAT file generated by the logging program.                      }

{ See TR.PAS for revision log  }

//{F+}
interface
uses //Overlay,
     //PostOnit,
     //Dos,
     //CRT,
    // Printer,
  Tree, {   452 bytes of data }
    // SlowTree,
  PostCab, {   714 bytes of data }
  PostLog, {   556 bytes of data }
  PostQSL, {     4 bytes of data }
  PostRpt, {  2050 bytes of data }
  PostSubs, { 39752 bytes of data }
  PostUtl, {    12 bytes of data }
  Country9, {  1454 bytes of data }
  LogDupe, {  3516 bytes of data }
  LogMenu, {     6 bytes of data }
  ZoneCont, {    50 bytes of data }
  LogWind,
  Dialogs,
  PostUnit; {  4666 bytes of data }

//{$O PostCab}
//{$O PostLog}
//{$O PostQSL}
//{$O PostRpt}
//{$O PostSubs}
//{$O PostUtl}
//{$O Country9}    { 18 K }
//{$O LogDupe}
//{$O LogMenu}
//{$O ZoneCont}    {  6 K }
//{$O LogWind}
//{$O LogDom}      {  4 K }
//{$O LogGrid}     {  6 K }
//{$O LogMenu}
//{$O LogSCP}      { 39 K }
//{$O PostSCP}     { 34 K }
//{$O LogName}
//{$O PostMult}
//{$O FContest}
//{$O SlowTree}

//{$L SUFFIX}
procedure MainScreen;
procedure Init;
procedure PostContestLogMassage;

implementation

procedure PostContestLogMassage;

var
  FileString: Str160;

begin
//    ClearScreenAndTitle ('POST CONTEST LOG PROCESSOR');

  WriteLn('This processor will step you through all the steps required to make sure your');
  WriteLn('log is properly duped and that all the country multipliers are properly');
  WriteLn('flagged.  It is a good idea to either run this procedure or at least the dupe');
  WriteLn('flag procedure before generating any reports or final logs.');
  WriteLn;

  if not FileExists(LogFileName) then
  begin
    WriteLn('I can not find the file ', LogFileName, '!!');
    WriteLn('I hope this is just a small error on your part and that your log has not been');
    WriteLn('erased.  Please use the F command on the next menu you will see to enter the');
    WriteLn('correct file name.');
//        WaitForKeyPressed;
    exit;
  end
  else
    WriteLn(LogFileName, ' has been found.');

  if not CheckForTempFile then exit;

//    WaitForKeyPressed;

//    ClearScreenAndTitle ('POST CONTEST LOG PROCESSOR');

  WriteLn('The next step will be to check the log carefully for dupes.');
//    WaitForKeyPressed;

  if not DupeLog then
  begin
    repeat
      Key := UpCase(GetKey('Do you want to stop this procedure now? (Y/N) :  '));
      if Key = EscapeKey then exit;
    until (Key = 'Y') or (Key = 'N');
    if Key = 'Y' then exit;
  end;

//    ClearScreenAndTitle ('POST CONTEST LOG PROCESSOR');

  WriteLn('The next step should only be done if your log has DX multipliers (countries).');
  WriteLn('If so, we will look at each QSO in your log and determine the country from');
  WriteLn('the callsign.  If the country cannot be determined from the callsign, you will');
  WriteLn('be given the chance to enter the proper country.  Also, the multiplier column');
  WriteLn('is examined to make sure no duplicate or missing multipliers exist.');
  WriteLn;

  repeat
    Key := UpCase(GetKey('Do you want to perform the multiplier check (Y/N) : '));
    if Key = EscapeKey then exit;
  until (Key = 'Y') or (Key = 'N');
  WriteLn;

  if Key = 'Y' then MultCheck;

//    ClearScreenAndTitle ('POST CONTEST LOG PROCESSOR');

  WriteLn('You have completed the Post Contest Log Massage.  After you have made any    ');
  WriteLn('necessary changes, execute the Create Band and/or Mode Log command under the');
  WriteLn('LOG PROCEDURE MENU.  This will generate page numbers, running totals of QSOs,');
  WriteLn('QSO points and multiplier totals at the bottom of each page.  Under the REPORT');
  WriteLn('PROCEDURE menu you will find procedures to generate dupe sheets, rate sheets');
  WriteLn('and some other interesting reports.  For ARRL contests, the A command under the');
  WriteLn('LOG PROCEDURE MENU will generate a file you can send to the ARRL instead of a');
  WriteLn('log and dupesheet.');
  WriteLn;
//    WaitForKeyPressed;
end;

procedure Init;

var
  Band: BandType;
  Mode: ModeType;
  Day, Hour: integer;

begin
  for Band := Band160 to All do
    for Mode := cw to Both do
    begin
      LogFileQSOsPrinted^[Band, Mode] := 0;
      LogFileQSOPoints^[Band, Mode] := 0;
      PageQSOPoints^[Band, Mode] := 0;
      PageValidContacts^[Band, Mode] := 0;
      TotalDomesticMults^[Band, Mode] := 0;
      TotalDXMults^[Band, Mode] := 0;
      TotalPrefixMults^[Band, Mode] := 0;
      TotalZoneMults^[Band, Mode] := 0;
      ValidContacts^[Band, Mode] := 0;

      NumberPageDomesticMults^[Band, Mode] := 0;
      NumberPageDXMults^[Band, Mode] := 0;
      NumberPagePrefixMults^[Band, Mode] := 0;
      NumberPageZoneMults^[Band, Mode] := 0;
    end;

  DoingDomesticMults := False;
  DoingDXMults := False;
  DoingPrefixMults := False;
  DoingZoneMults := False;
  NumberBufferCalls := 0;
  NumberLogFilesOpen := 0;
  LastNewList := 0;
  QSOByBandAndModeDetermined := False;

end;

procedure MainScreen;

var
  TempString: Str80;

begin
//    ClearScreenAndTitle ('TR POST CONTEST PROGRAM  Version ' + PostVersion);

{  WriteLn('Welcome to the TR Post Contest Program.  You will find many procedures and ');
  WriteLn('utilities here to help you after the contest.  There are a number of procedures');
  WriteLn('under the Log procedures menu.  These will perform various things to your log');
  WriteLn('file.  The QSL procedures menu has everything you need to support QSLing.  The');
  WriteLn('Report procedures menu has a number of different reports that can be generated');
  WriteLn('and finally the Utility procedures menu has a number of little programs to make');
  WriteLn('your life easier.  To get more information on any of these, go into the desired');
  WriteLn('menu and execute the procedure you are interested in.  An explanation of the');
  WriteLn('procedure will be displayed and you will always be able to exit the procedure');
  WriteLn('before actually doing anything (use ESCAPE or RETURN with no input).');
  WriteLn;
  WriteLn ('Free memory = ', MaxAvail);
  WriteLn;
  Write('  F - Change active log filename (active logfile = ');
  ;}

{      TextColor (Yellow);
  Write(LogFileName);
    TextColor (Cyan);
  WriteLn(').');
  WriteLn('  C - Create Cabrillo File.');
  WriteLn('  L - Log procedures menu.');
  WriteLn('  P - Post contest log processor (steps you through most everything).');
  WriteLn('  Q - QSL procedures menu.');
  WriteLn('  R - Report procedures menu.');
  WriteLn('  U - Utility procedures menu.');
  WriteLn('  X - Exit program.');
  WriteLn;

//    TextColor (Cyan);
  Write('  Enter command : ');

  repeat
//        REPEAT UNTIL KeyPressed;
//        Key := UpCase (ReadKey);

    case Key of
      'C': begin
          CreateCabrilloFile;
          exit;
        end;

      'F': begin
          LogFileName := GetResponse('Enter new active logfile (none to use menu) : ');

          if LogFileName = '' then
          begin

                     //wli                     LogFilename := SelectAvailableLog;

            if (LogFileName = 'LOGCFG') or (LogFileName = '') then
              LogFileName := 'LOG.DAT'
            else
              LogFileName := LogFileName + '.DAT';
          end;

          exit;
        end;

      'L': begin
          repeat until not LogProcedureMenu;
          exit;
        end;

      'P': begin
          PostContestLogMassage;
          exit;
        end;

      'Q': begin
          repeat until not QSLProcedureMenu;
          exit;
        end;

      'R': begin
          repeat until not ReportProcedureMenu;
          exit;
        end;

      'U': begin
          repeat until not UtilityMenu;
          exit;
        end;

      'X', EscapeKey: begin
//          NormVideo;
//          ClrScr;
          halt;
        end;

    end;
  until False;
  }
end;

begin

//  NoSound;
//  ClrScr;

//  WriteLn('Initializing...');

  if not CountryTable.LoadInCountryFile then
  begin
    SHOWMESSAGE('Unable to load CTY.DAT file.');
    halt;
  end;

  CWEnable := true;
  LogTotalsAccurate := False;

  if ParamCount > 0 then
    LogFileName := ParamStr(1)
  else
    LogFileName := 'LOG.DAT';

//  ClrScr;

  New(LogFileQSOPoints);
  New(LogFileQSOsPrinted);

  New(PageQSOPoints);
  New(PageValidContacts);

  New(TotalDomesticMults);
  New(TotalDXMults);
  New(TotalPrefixMults);
  New(TotalZoneMults);

  New(NumberPageDomesticMults);
  New(NumberPageDXMults);
  New(NumberPagePrefixMults);
  New(NumberPageZoneMults);

  New(ValidContacts);

//wli  LogFilename := SelectAvailableLog;

//  repeat
 //   Init;
//    MainScreen;
//    ClrScr;
//  until False;
end.

